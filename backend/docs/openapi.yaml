openapi: 3.1.0
info:
  title: Fuga music api
  version: 1.0.0

servers:
  - url: /api
    description: Local development server

paths:
  /healthz:
    get:
      summary: API health check
      description: Returns the API status and uptime
      tags:
        - Health
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /products:
    get:
      summary: List all available products
      description: Returns all available products
      parameters:
        - in: query
          name: cursor
          schema: { type: string }
          description: Opaque pagination cursor.
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: q
          schema: { type: string }
          description: Full-text search query.
      responses:
        '200':
          description: A list of available products
          headers:
            X-Next-Cursor:
              schema: { type: string }
              description: Present if there is another page.
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProductsResponse'

    post:
      summary: Create a new product
      description: Creates a new product
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreate'
      responses:
        '201':
          description: Product created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'

  /products/{productId}:
    parameters:
      - in: path
        name: productId
        required: true
        schema: { type: string, format: uuid }
    get:
      summary: Get product
      responses:
        '200':
          description: The product
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          $ref: '#/components/responses/NotFound'

    post:
      summary: Update product
      description: Updates an existing product
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProductCreate'
      responses:
        '200':
          description: Product updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Product'
        '404':
          $ref: '#/components/responses/NotFound'

  /presign:
    post:
      summary: Get a presigned URL for image upload
      description: Returns a presigned URL for uploading an image to object storage
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PresignRequest'
      responses:
        '200':
          description: Presigned URL and storage key
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PresignResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  parameters:
    ProductId:
      in: path
      name: productId
      required: true
      schema: { type: string, format: uuid }

  responses:
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema: { $ref: '#/components/schemas/Error' }

  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - uptime
      properties:
        status:
          type: string
          example: ok
        uptime:
          type: number
          description: Time in seconds since the API started
          example: 123.456

    Product:
      type: Object
      required: [id, title, artist, createdAt, updatedAt]
      properties:
        id: { type: string, format: uuid }
        title: { type: string, minLength: 1, maxLength: 200 }
        artist: { type: string, minLength: 1, maxLength: 200 }
        image:
          $ref: '#/components/schemas/ImageRef'
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }

    ProductsResponse:
      type: object
      required: [products]
      properties:
        products:
          type: array
          items:
            $ref: '#/components/schemas/Product'

    ProductCreate:
      type: object
      required: [title, artist, imageKey]
      properties:
        title: { type: string, minLength: 1 }
        artist: { type: string, minLength: 1 }
        imageKey:
          {
            type: string,
            description: 'Object storage key for a previously uploaded original',
            nullable: true,
          }

    ImageRef:
      type: object
      required: [url, width, height, format]
      properties:
        url: { type: string, format: uri }
        key: { type: string }
        width: { type: integer }
        height: { type: integer }
        format: { type: string, enum: [jpeg, png, webp] }

    PresignRequest:
      type: object
      required: [fileName, fileType, fileSize]
      properties:
        fileName:
          type: string
          description: Original filename of the image
        fileType:
          type: string
          description: MIME type of the image (e.g., image/png)
        fileSize:
          type: integer
          description: Size of the image in bytes

    PresignResponse:
      type: object
      required: [url, fields, storageKey]
      properties:
        url:
          type: string
          format: uri
          description: Presigned POST URL for uploading the image
        fields:
          type: object
          additionalProperties:
            type: string
          description: Form fields to include in the POST request
        storageKey:
          type: string
          description: Object storage key for the uploaded image

    Error:
      type: object
      required:
        - title
      properties:
        title:
          type: string
          example: 'An error occurred'
        message:
          type: string
          example: 'Detailed error message'
        code:
          type: integer
          example: 500
